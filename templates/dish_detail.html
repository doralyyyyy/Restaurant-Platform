
{% extends "base.html" %}
{% block title %}{{ dish.name }} - {{ restaurant.name }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb small">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('restaurants') }}">æ‰€æœ‰é¤å…</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('restaurant_menu', restaurant_id=restaurant.id, category_id=dish.category_id) }}">
                        {{ restaurant.name }}
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">{{ dish.name }}</li>
            </ol>
        </nav>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('my_table', restaurant_id=restaurant.id) }}" class="btn btn-outline-success btn-sm">
            <i class="bi bi-basket me-1"></i> æˆ‘çš„é¤æ¡Œ
        </a>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-5">
        <div class="card shadow-sm">
            {% if dish.image %}
                <img src="{{ url_for('static', filename=dish.image) }}" class="card-img-top" alt="{{ dish.name }}">
            {% elif dish.thumb %}
                <img src="{{ url_for('static', filename=dish.thumb) }}" class="card-img-top" alt="{{ dish.name }}">
            {% endif %}
            <div class="card-body">
                <h3 class="card-title mb-2">{{ dish.name }}</h3>
                <p class="text-danger fw-bold fs-5 mb-2">ï¿¥{{ '%.2f'|format(dish.price) }}</p>
                <p class="card-text small text-muted">
                    åˆ†ç±»ï¼š{{ dish.category.name }}
                </p>
                <p class="card-text">
                    {{ dish.description or 'æš‚æ— ä»‹ç»ã€‚' }}
                </p>
                <form method="post" action="{{ url_for('add_to_cart_route', dish_id=dish.id) }}">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i> åŠ å…¥æˆ‘çš„é¤æ¡Œ
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-7" id="ask">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="mb-3">
                    <h5 class="card-title mb-2">
                        <i class="bi bi-chat-dots-fill me-2 text-info"></i>æ™ºèƒ½ç‚¹é¤é¡¾é—®
                    </h5>
                    <p class="text-muted small mb-3">
                        é»˜è®¤ä¼šå›´ç»• <strong class="text-primary">{{ dish.name }}</strong> å›ç­”ã€‚è‹¥ä½ åœ¨é—®é¢˜ä¸­æ˜ç¡®æåˆ°å…¶ä»–èœåï¼Œ
                        æ™ºèƒ½é¡¾é—®ä¹Ÿä¼šç»¼åˆè€ƒè™‘é¤å…å…¨éƒ¨èœå“æ¥å›ç­”ã€‚
                    </p>
                    <div class="mb-3">
                        <small class="text-muted d-block mb-2">ğŸ’¡ å¿«é€Ÿé—®é¢˜ï¼š</small>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-outline-info quick-question-btn"
                                    onclick="setDishQuestion('è¿™é“èœé€‚åˆé…ä»€ä¹ˆé¥®å“ï¼Ÿ')">
                                æ­é…å»ºè®®
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info quick-question-btn"
                                    onclick="setDishQuestion('è¿™é“èœçš„å£å‘³å¦‚ä½•ï¼Ÿ')">
                                å£å‘³ç‰¹ç‚¹
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info quick-question-btn"
                                    onclick="setDishQuestion('è¿™é“èœå—æ¬¢è¿å—ï¼Ÿ')">
                                å—æ¬¢è¿ç¨‹åº¦
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info quick-question-btn"
                                    onclick="setDishQuestion('æ¨èå‡ é“ç±»ä¼¼çš„èœå“')">
                                ç±»ä¼¼æ¨è
                            </button>
                        </div>
                    </div>
                </div>
                <form method="post" class="mb-3 flex-grow-0" id="dishQuestionForm">
                    <div class="mb-3">
                        <label class="form-label small fw-semibold">ä½ çš„é—®é¢˜</label>
                        <textarea class="form-control" name="question" rows="3" id="dishQuestionInput"
                                  placeholder="ä¾‹å¦‚ï¼šè¿™é“èœè¾£å—ï¼Ÿé€‚åˆé…ä»€ä¹ˆé¥®å“ï¼Ÿ">{{ question or '' }}</textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small">
                            <i class="bi bi-info-circle me-1"></i>è¿™æ˜¯ä¸ç³»ç»Ÿçš„æ™ºèƒ½èŠå¤©ï¼Œä¸å½±å“å®é™…ç‚¹é¤
                        </span>
                        <button type="submit" class="btn btn-primary btn-sm" id="dishSubmitBtn">
                            <i class="bi bi-stars me-1"></i> å‘é€é—®é¢˜
                        </button>
                    </div>
                </form>
                <div id="dishLoadingIndicator" style="display: none;" class="mb-3">
                    <div class="d-flex align-items-center text-muted small">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <span>AIé¡¾é—®æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨å€™...</span>
                    </div>
                </div>
                {% if answer %}
                    <hr class="my-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-robot text-info me-2"></i>
                        <h6 class="mb-0 fw-semibold">æ™ºèƒ½é¡¾é—®å›ç­”ï¼š</h6>
                    </div>
                    <div class="advisor-answer small">
                        {{ answer|format_ai|safe }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function setDishQuestion(text) {
    const questionInput = document.getElementById('dishQuestionInput');
    if (questionInput) {
        questionInput.value = text;
        questionInput.focus();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('dishQuestionForm');
    const submitBtn = document.getElementById('dishSubmitBtn');
    const loadingIndicator = document.getElementById('dishLoadingIndicator');
    
    if (form) {
        form.addEventListener('submit', function() {
            const questionInput = document.getElementById('dishQuestionInput');
            if (questionInput && questionInput.value.trim()) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>å‘é€ä¸­...';
                loadingIndicator.style.display = 'block';
            }
        });
    }
});
</script>
{% endblock %}
